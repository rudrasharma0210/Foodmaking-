<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Recipe Idea Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3f0; /* Light parchment color */
        }
        .container-card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        .btn-primary {
            background-color: #e27d60; /* Deep coral */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #d16e55;
        }
        .loading-indicator {
            border-top-color: #e27d60;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div id="app-container" class="w-full max-w-2xl mt-10 p-6 sm:p-8 rounded-xl container-card">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6 flex items-center justify-center">
            <svg class="w-8 h-8 mr-2 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.761 1.761 0 01-1.378 1.73l-.48.16C8.834 21.365 8 21.033 8 20.375v-1.745l-1.558.52a1.761 1.761 0 01-1.378 1.73l-.48.16C3.834 21.365 3 21.033 3 20.375V4.625c0-.658.834-.989 1.378-.81l.48.16A1.761 1.761 0 016 4.76V18.12l1.558-.52a1.761 1.761 0 011.378-1.73l.48-.16c.544-.18 1.378.147 1.378.805V5.882zM15 14.733V5.882l2.558-.854a1.761 1.761 0 011.378-1.73l.48-.16c.544-.18 1.378.147 1.378.805V19.24a1.761 1.761 0 01-1.378 1.73l-.48.16c-.544.18-1.378-.147-1.378-.805v-1.745l-1.558.52a1.761 1.761 0 01-1.378 1.73l-.48.16c-.544.18-1.378-.147-1.378-.805V14.733z"></path></svg>
            AI Recipe Generator
        </h1>
        <p class="text-center text-gray-600 mb-6">Tell Gemini what ingredients you have, dietary restrictions, or a desired cuisine!</p>

        <!-- Input Form -->
        <div class="space-y-4 mb-8">
            <label for="prompt-input" class="block text-sm font-medium text-gray-700">Your Recipe Idea / Ingredients:</label>
            <textarea id="prompt-input" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-300 transition duration-150" placeholder="e.g., 'A quick vegetarian dinner using broccoli and pasta', or 'A gourmet steak recipe for a special occasion'." value="A quick dinner recipe using chicken, rice, and soy sauce, ready in under 30 minutes."></textarea>
            <button id="generate-button" class="btn-primary text-white w-full py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl transition duration-200">
                Generate Recipe
            </button>
        </div>

        <!-- Recipe Output -->
        <div id="output-section" class="pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your AI-Generated Recipe:</h2>
            <div id="recipe-output" class="min-h-[150px] p-4 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 whitespace-pre-wrap">
                <!-- Recipe content will appear here -->
                <p class="text-gray-500 italic">Click "Generate Recipe" to get started!</p>
            </div>
        </div>

        <!-- Error/Loading Messages -->
        <div id="message-area" class="mt-4 text-center">
            <!-- Loading Spinner -->
            <div id="loading-spinner" class="hidden flex items-center justify-center space-x-2">
                <div class="loading-indicator h-6 w-6 border-4 border-t-4 border-gray-200 rounded-full"></div>
                <span class="text-red-500 font-medium">Generating culinary brilliance...</span>
            </div>
            <!-- Error Message -->
            <p id="error-message" class="hidden text-red-500 font-medium"></p>
        </div>
    </div>

    <script type="module">
        // --- Firebase/Gemini Setup (MANDATORY BOILERPLATE) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;

        if (Object.keys(firebaseConfig).length > 0) {
            setLogLevel('Debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Auth function
            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Authenticated successfully with custom token.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Authenticated anonymously.");
                    }
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                    document.getElementById('error-message').textContent = 'Authentication failed. See console for details.';
                    document.getElementById('error-message').classList.remove('hidden');
                }
            }
            authenticate();
        } else {
            console.warn("Firebase config not available. App will still function by calling the Gemini API directly, but persistence features are unavailable.");
        }

        // --- Core Application Logic ---

        const generateButton = document.getElementById('generate-button');
        const promptInput = document.getElementById('prompt-input');
        const recipeOutput = document.getElementById('recipe-output');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');

        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
        const MODEL = 'gemini-2.5-flash-preview-09-2025';

        // Function to make the API call with exponential backoff
        async function fetchWithBackoff(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Check for rate limiting (429) or other API errors
                        if (response.status === 429 && i < retries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            console.log(`Rate limit hit (429). Retrying in ${delay / 1000}s...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Go to next retry iteration
                        }
                        throw new Error(`API error: ${response.statusText} (Status: ${response.status})`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) {
                        throw error; // Throw the error if all retries fail
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Fetch error: ${error.message}. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function generateRecipe() {
            const userPrompt = promptInput.value.trim();

            if (!userPrompt) {
                recipeOutput.innerHTML = '<p class="text-red-500 font-medium">Please enter a description to generate a recipe.</p>';
                return;
            }

            // UI state management
            generateButton.disabled = true;
            generateButton.textContent = 'Generating...';
            loadingSpinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            recipeOutput.textContent = '';
            recipeOutput.classList.remove('bg-gray-50', 'text-gray-700');
            recipeOutput.classList.add('bg-gray-100', 'text-gray-500', 'italic');

            // --- LLM API Call Configuration ---

            const systemInstruction = `You are a world-class culinary AI assistant. Your task is to generate a single, complete, delicious, and easy-to-follow recipe based on the user's request.
            
            The recipe MUST include:
            1. Recipe Title (H3 format).
            2. Ingredients (as an unordered list).
            3. Instructions (as a numbered list).
            
            Format the output strictly using Markdown, ensuring it is easy to read. Do not include any introductory or concluding conversational text outside the generated recipe text.`;

            const fullPrompt = `Generate a recipe for: ${userPrompt}`;

            const payload = {
                contents: [{ parts: [{ text: fullPrompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                // Enable Google Search grounding to find modern techniques or specific ingredient details
                tools: [{ "google_search": {} }],
                config: {
                    temperature: 0.8,
                }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithBackoff(API_URL, options);
                const result = await response.json();
                
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const markdownText = candidate.content.parts[0].text;
                    
                    // Simple Markdown to HTML conversion for display
                    let htmlContent = markdownText
                        .replace(/^### (.*)$/gm, '<h3 class="text-xl font-bold mb-3">$1</h3>') // H3 to H3
                        .replace(/^\* (.*)$/gm, '<li class="ml-4 list-disc">$1</li>') // Unordered list to li
                        .replace(/^- (.*)$/gm, '<li class="ml-4 list-disc">$1</li>') // Unordered list (alternative) to li
                        .replace(/^[0-9]+\. (.*)$/gm, '<li class="ml-4 list-decimal mt-1">$1</li>') // Numbered list to li
                        .replace(/\n\n/g, '<p class="mt-4"></p>') // Double newline to paragraph break
                        .replace(/\n/g, '<br/>'); // Single newline to line break

                    // Wrap lists properly (simple approach)
                    htmlContent = htmlContent.replace(/<li class="ml-4 list-disc">[\s\S]*?<\/li>/g, match => `<ul class="list-inside mb-4">${match}</ul>`);
                    htmlContent = htmlContent.replace(/<li class="ml-4 list-decimal mt-1">[\s\S]*?<\/li>/g, match => `<ol class="list-inside mb-4">${match}</ol>`);
                    
                    // Final cleanup: remove residual list item wrappers
                    htmlContent = htmlContent.replace(/<\/ul>\n?<ul class="list-inside mb-4">/g, '');
                    htmlContent = htmlContent.replace(/<\/ol>\n?<ol class="list-inside mb-4">/g, '');
                    
                    // Remove initial paragraph tag if generated
                    htmlContent = htmlContent.trim().startsWith('<p class="mt-4"></p>') ? htmlContent.trim().substring('<p class="mt-4"></p>'.length) : htmlContent.trim();
                    
                    recipeOutput.innerHTML = htmlContent;
                    recipeOutput.classList.remove('bg-gray-100', 'text-gray-500', 'italic');
                    recipeOutput.classList.add('bg-white', 'text-gray-800');

                    // Handle citations (Grounding Metadata)
                    const groundingMetadata = candidate.groundingMetadata;
                    let sourcesHtml = '';
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        const sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);

                        if (sources.length > 0) {
                            sourcesHtml += '<p class="text-sm text-gray-500 mt-4 font-semibold">Sources:</p><ul class="text-xs text-gray-500 list-disc pl-5">';
                            sources.slice(0, 3).forEach(source => { // Limit to 3 sources for clean UI
                                sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="hover:underline">${source.title}</a></li>`;
                            });
                            sourcesHtml += '</ul>';
                        }
                    }
                    recipeOutput.innerHTML += sourcesHtml;
                } else {
                     throw new Error('Could not generate recipe content. Check API response for errors.');
                }

            } catch (error) {
                console.error("Gemini API call failed:", error);
                errorMessage.textContent = `Error: Failed to generate recipe. Please check the console for details.`;
                errorMessage.classList.remove('hidden');
                recipeOutput.textContent = 'Oops! Something went wrong while contacting the AI chef.';
                recipeOutput.classList.remove('bg-gray-100', 'text-gray-500', 'italic');
                recipeOutput.classList.add('bg-red-50', 'text-red-700');
            } finally {
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Recipe';
                loadingSpinner.classList.add('hidden');
            }
        }

        generateButton.addEventListener('click', generateRecipe);

        // Run on load with a default prompt (optional, but good for first view)
        // window.onload = () => {
        //     generateRecipe();
        // }

    </script>
</body>
</html>
